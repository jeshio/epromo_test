agGrid.initialiseAgGridWithAngular1(angular),angular.module("epromoApp",["ngResource","ngRoute","agGrid","chart.js"]).config(["$routeProvider",function(e){e.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("epromoApp").controller("MainCtrl",["$scope","$http",function(e,a){function t(a){e.records=[];var t=[];angular.forEach(a,function(e){var a={adSearch:e.adgroup_name,phrase:e.phrase,shows:e.stat.shows,clicks:e.stat.clicks,sum:e.stat.sum};o+=e.stat.shows,s+=e.stat.clicks,n+=e.stat.sum,angular.forEach(e.campaign.groups,function(r){void 0===t[r.name]&&(t[r.name]=[]),void 0===t[r.name][e.adgroup_name]&&(t[r.name][e.adgroup_name]=[]),t[r.name][e.adgroup_name].push(Object.assign(a,{groupSearch:r.name}))})});for(var r in t){var i=[];for(var u in t[r])i.push({adGroup:u,results:t[r][u]});var l={group:r,adGroups:i};e.records.push(l)}e.records.unshift({shows:o,clicks:s,sum:n})}function r(e){return e.group?{group:!0,expanded:e.open,children:e.adGroups,field:"group",key:e.group}:e.adGroup?{group:!0,children:e.results,expanded:e.open,field:"adGroup",key:e.adGroup}:null}e.pageSize=10,e.records=[],e.startDate="2016-07-01",e.endDate="";var o=0,s=0,n=0,i=[{headerName:"Group",cellRenderer:"group",field:"group",cellRendererParams:{innerRenderer:function(e){return e.data.group?e.data.group:null}}},{headerName:"Ad Groups",cellRenderer:"group",field:"adGroup",cellRendererParams:{innerRenderer:function(e){return e.data.adGroup?e.data.adGroup:null}}},{headerName:"Phrase",field:"phrase"},{headerName:"Shows",field:"shows",width:100,filter:"number"},{headerName:"Clicks",field:"clicks",width:100,filter:"number"},{headerName:"Sum",field:"sum",width:100,filter:"number"},{headerName:"",field:"groupSearch",hide:!0},{headerName:"",field:"adSearch",hide:!0}];e.gridOptions={columnDefs:i,enableColResize:!0,enableSorting:!0,enableFilter:!0,rowModelType:"pagination",getNodeChildDetails:r,onGridReady:function(a){a.api.sizeColumnsToFit(),e.loadTable()}},e.onFilterChanged=function(a){e.gridOptions.api.setQuickFilter(a)},e.onPageSizeChange=function(){e.loadTable()},e.loadTable=function(){var r={pageSize:e.pageSize,rowCount:-1,getRows:function(r){var o=r.startRow,s=r.endRow-r.startRow,n="http://localhost:5000/api/table?startDate="+e.startDate+"&endDate="+e.endDate+"&offset="+o+"&limit="+s;a.get(n).then(function(a){t(a.data.data),r.successCallback(e.records)})}};e.gridOptions.api.setDatasource(r)},e.shows=e.clicks=e.sum=!0,e.setShows=function(a){e.gridOptions.columnApi.setColumnVisible("shows",a)},e.setClicks=function(a){e.gridOptions.columnApi.setColumnVisible("clicks",a)},e.setSum=function(a){e.gridOptions.columnApi.setColumnVisible("sum",a)}}]),angular.module("epromoApp").controller("GraphCtrl",["$scope","$http",function(e,a){function t(e){return _.keys(e).map(function(a){return{stat_date:e[a][0].stat_date,shows:_(e[a]).reduce(function(e,a){return e+a.shows},0),clicks:_(e[a]).reduce(function(e,a){return e+a.clicks},0),CTR:_(e[a]).reduce(function(e,a){return e+a.CTR},0)}})}e.graph={units:[{unit:"День",value:"day"},{unit:"Неделя",value:"week"},{unit:"Месяц",value:"month"}]},e.graph.graphUnit=e.graph.units[0],e.labels=[],e.series=["Clicks","Shows","CTR"],e.data=[],e.time={format:"YYYY-MM-DD",tooltipFormat:"YYYY-MM-DD"},e.options={responsive:!0,scales:{xAxes:[{type:"time",time:e.time}]}},e.setUnit=function(){switch(e.graph.graphUnit.value){case"day":e.time={format:"YYYY-MM-DD",tooltipFormat:"YYYY-MM-DD"},e.groupedData=e.response;break;case"week":e.time={format:"YYYY-MM-DD",tooltipFormat:"YYYY-MM-DD",unit:"week"};var a=_.groupBy(e.response,function(e){return moment(e.stat_date,"YYYY-MM-DD").isoWeek()});e.groupedData=t(a);break;case"month":e.time={format:"YYYY-MM",tooltipFormat:"YYYY-MM",unit:"month"};var a=_.groupBy(e.response,function(e){return moment(e.stat_date,"YYYY-MM-DD").month()});e.groupedData=t(a)}e.options={responsive:!0,scales:{xAxes:[{type:"time",time:e.time}]}},e.setData()};var r="http://localhost:5000/api/chart?startDate="+e.startDate+"&endDate="+e.endDate;e.clicks=e.shows=e.CTR=[],e.showClicks=e.showShows=e.showCTR=!0,e.response=[],e.groupedData=[],a.get(r).then(function(a){e.groupedData=e.response=a.data.data,e.setData()}),e.setData=function(){e.series=[],e.labels=e.groupedData.map(function(e){return new Date(e.stat_date)}),e.clicks=e.groupedData.map(function(e){return e.clicks}),e.shows=e.groupedData.map(function(e){return e.shows}),e.CTR=e.groupedData.map(function(e){return e.CTR}),e.data=[],e.showClicks&&(e.data.push(e.clicks),e.series.push("Clicks")),e.showShows&&(e.data.push(e.shows),e.series.push("Shows")),e.showCTR&&(e.data.push(e.CTR),e.series.push("CTR"))}}]);