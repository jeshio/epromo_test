agGrid.initialiseAgGridWithAngular1(angular),angular.module("epromoApp",["ngResource","ngRoute","agGrid","chart.js","datePicker"]).config(["$routeProvider",function(e){e.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("epromoApp").controller("MainCtrl",["$scope","$http",function(e,a){function t(a){var t=0,r=0,o=0;e.records=[];var s,n,i,u,d,p,l=[];angular.forEach(a,function(e){var a={adSearch:e.adgroup_name,phrase:e.phrase,shows:e.stat.shows,clicks:e.stat.clicks,sum:e.stat.sum};angular.forEach(e.campaign.groups,function(t){void 0===l[t.name]&&(l[t.name]=[]),void 0===l[t.name][e.adgroup_name]&&(l[t.name][e.adgroup_name]=[]),l[t.name][e.adgroup_name].push(Object.assign(a,{groupSearch:t.name}))})});for(var c in l){s=n=i=0;var h=[];for(var m in l[c]){u=d=p=0;for(var g in l[c][m])u+=l[c][m][g].clicks,d+=l[c][m][g].shows,p+=l[c][m][g].sum;s+=u,n+=d,i+=p,h.push({adGroup:m,shows:d,clicks:u,sum:p,results:l[c][m]})}var f={group:c,shows:n,clicks:s,sum:i,adGroups:h};e.records.push(f),t+=n,r+=s,o+=i}e.records.unshift({shows:t,clicks:r,sum:o})}function r(e){return e.group?{group:!0,expanded:e.open,children:e.adGroups,field:"group",key:e.group}:e.adGroup?{group:!0,children:e.results,expanded:e.open,field:"adGroup",key:e.adGroup}:null}e.pageSize=10,e.records=[],e.table={startDate:moment("2016-07-01"),endDate:moment("2016-07-25")};var o=[{headerName:"Group",cellRenderer:"group",field:"group",cellRendererParams:{innerRenderer:function(e){return e.data.group?e.data.group:null}}},{headerName:"Ad Groups",cellRenderer:"group",field:"adGroup",cellRendererParams:{innerRenderer:function(e){return e.data.adGroup?e.data.adGroup:null}}},{headerName:"Phrase",field:"phrase"},{headerName:"Shows",field:"shows",width:100,filter:"number"},{headerName:"Clicks",field:"clicks",width:100,filter:"number"},{headerName:"Sum",field:"sum",width:100,filter:"number"},{headerName:"",field:"groupSearch",hide:!0},{headerName:"",field:"adSearch",hide:!0}];e.gridOptions={columnDefs:o,enableColResize:!0,enableSorting:!0,enableFilter:!0,rowModelType:"pagination",getNodeChildDetails:r,onGridReady:function(a){a.api.sizeColumnsToFit(),e.loadTable()}},e.onFilterChanged=function(a){e.gridOptions.api.setQuickFilter(a)},e.onPageSizeChange=function(){e.loadTable()},e.loadTable=function(){var r={pageSize:e.pageSize,rowCount:-1,getRows:function(r){var o=r.startRow,s=r.endRow-r.startRow,n="/api/table?startDate="+e.table.startDate.format("YYYY-MM-DD")+"&endDate="+e.table.endDate.format("YYYY-MM-DD")+"&offset="+o+"&limit="+s;a.get(n).then(function(a){t(a.data.data),r.successCallback(e.records)})}};e.gridOptions.api.setDatasource(r)},e.shows=e.clicks=e.sum=!0,e.setShows=function(a){e.gridOptions.columnApi.setColumnVisible("shows",a)},e.setClicks=function(a){e.gridOptions.columnApi.setColumnVisible("clicks",a)},e.setSum=function(a){e.gridOptions.columnApi.setColumnVisible("sum",a)}}]),angular.module("epromoApp").controller("GraphCtrl",["$scope","$http",function(e,a){function t(e){return _.keys(e).map(function(a){return{stat_date:e[a][0].stat_date,shows:_(e[a]).reduce(function(e,a){return e+a.shows},0),clicks:_(e[a]).reduce(function(e,a){return e+a.clicks},0),CTR:_(e[a]).reduce(function(e,a){return e+a.CTR},0)}})}e.setData=function(){e.datasetOverride=[],e.series=[],e.labels=e.groupedData.map(function(e){return new Date(e.stat_date)}),e.clicks=e.groupedData.map(function(e){return e.clicks}),e.shows=e.groupedData.map(function(e){return e.shows}),e.CTR=e.groupedData.map(function(e){return e.CTR}),e.data=[],e.showClicks&&(e.data.push(e.clicks),e.series.push("Clicks"),e.datasetOverride.push({yAxisID:"y-axis-1"})),e.showShows&&(e.data.push(e.shows),e.series.push("Shows"),e.datasetOverride.push({yAxisID:"y-axis-1"})),e.showCTR&&(e.data.push(e.CTR),e.series.push("CTR"),e.datasetOverride.push({yAxisID:"y-axis-2"})),e.applyOptions()},e.applyOptions=function(){e.yAxes=[{id:"y-axis-1",type:"linear",display:e.showShows||e.showClicks,position:"left"},{id:"y-axis-2",type:"linear",display:e.showCTR,position:"right"}],e.options={responsive:!0,scales:{xAxes:[{type:"time",time:e.time}],yAxes:e.yAxes}}},e.chart={startDate:moment("2016-07-01"),endDate:moment("2016-09-01")},e.clicks=e.shows=e.CTR=[],e.showClicks=e.showShows=e.showCTR=!0,e.response=[],e.groupedData=[],e.loadGraph=function(){var t="/api/chart?startDate="+e.chart.startDate.format("YYYY-MM-DD")+"&endDate="+e.chart.endDate.format("YYYY-MM-DD");a.get(t).then(function(a){e.groupedData=e.response=a.data.data,e.setData()})},e.loadGraph(),e.graph={units:[{unit:"День",value:"day"},{unit:"Неделя",value:"week"},{unit:"Месяц",value:"month"}]},e.graph.graphUnit=e.graph.units[0],e.labels=[],e.series=["Clicks","Shows","CTR"],e.datasetOverride=[],e.data=[],e.time={format:"YYYY-MM-DD",tooltipFormat:"YYYY-MM-DD"},e.yAxes=[],e.options={responsive:!0},e.applyOptions(),e.setUnit=function(){switch(e.graph.graphUnit.value){case"day":e.time={format:"YYYY-MM-DD",tooltipFormat:"YYYY-MM-DD"},e.groupedData=e.response;break;case"week":e.time={format:"YYYY-MM-DD",tooltipFormat:"YYYY-MM-DD",unit:"week"};var a=_.groupBy(e.response,function(e){return moment(e.stat_date,"YYYY-MM-DD").isoWeek()});e.groupedData=t(a);break;case"month":e.time={format:"YYYY-MM",tooltipFormat:"YYYY-MM",unit:"month"};var a=_.groupBy(e.response,function(e){return moment(e.stat_date,"YYYY-MM-DD").month()});e.groupedData=t(a)}e.setData()}}]);